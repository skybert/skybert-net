#! /usr/bin/env bash

remote_dir=www
src_dir=$HOME/src/skybert-net
rsync_opts="
--recursive
--compress
--checksum
--cvs-exclude
"

feed_output_file=skybert-net-feed.xml
sync_dir_list="
  ssi
  generated/${feed_output_file}
  emacs
  diary
  java
  unix
  linux
  bytes
  db
"
conf_file=$HOME/.$(basename $0).conf

source $conf_file 2>/dev/null || {
  echo "I cannot live without $conf_file :-("
  exit 1
}

if [ -z $remote_host ]; then
  echo "$conf_file must have remote_host"
  exit 1
elif [ -z $remote_user ]; then
  echo "$conf_file must have remote_user"
  exit 1
fi
  
function wee_push() {
  for el in $sync_dir_list; do
    if [ -d ${src_dir}/$el ]; then
      echo "Pushing" $el "articles ..."
      rsync $rsync_opts \
        $src_dir/$el/ \
        ${remote_user}@${remote_host}:${remote_dir}/$el/
    elif [ -e $src_dir/$el ]; then
      echo "Pushing single file:" $el "..."
      rsync $rsync_opts \
        $src_dir/$el \
        ${remote_user}@${remote_host}:${remote_dir}/
    fi
  done

  find $src_dir/generated  -maxdepth 1 -type d | while read f; do
    local dir=$(basename $f)
    if [[ "$dir" == "generated" ]]; then
      continue
    fi
    echo "Pushing generated" $dir "articles ..."
    rsync $rsync_opts \
      $src_dir/generated/$dir/ \
      ${remote_user}@${remote_host}:${remote_dir}/$dir/
  done
}

function wee_outgoing() {
  rsync $rsync_opts --dry-run $src_dir/ \
    ${remote_user}@${remote_host}:${remote_dir}/
}

function wee_incoming() {
  rsync $rsync_opts --dry-run \
    ${remote_user}@${remote_host}:${remote_dir}/ \
    $src_dir/ 
}

function wee_feed() {
  echo "Generating Atom feed in" $feed_output_file "..."
  cd $HOME/src/common-bashing/src/org2atom
  ./org2atom $HOME/src/skybert-net/src | \
    xmllint --format - \
    > $src_dir/generated/${feed_output_file}
}

function wee_generate() {
  cd $HOME/src/common-bashing/src/org2html
  ./org2html
}

function wee_pull() {
  rsync $rsync_opts ${remote_user}@${remote_host}:${remote_dir}/ \
    $src_dir/
}

function get_fn_list() {
  declare -f | grep ^wee | grep "()" | cut -d'_' -f2 | cut -d' ' -f1
}

## A wee bit of BSD inspiration here...
function wee_world() {
  wee_generate
  wee_feed
  wee_push
}

for el in $(get_fn_list); do
  if [[ ${1} == ${el} ]]; then
    wee_${1}
    break
  fi
done
    
if [[ $1 == "--help" ]]; then
  cat <<EOF
  Usage: $(basename $0) <command>

   Commands available:
EOF

   for el in $(get_fn_list); do
     echo "    -" $el
   done
fi

